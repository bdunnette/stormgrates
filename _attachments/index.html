<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #mapid {
            height: 100%;
            width: 100%;
        }
    </style>
    <title>CouchApp</title>
</head>

<body>
    <div id="mapid"></div>
    <script>
        var mymap = L.map('mapid').setView([44.9, -93.2], 14);

        L.tileLayer(
            'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                    '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                    'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox.streets'
            }).addTo(mymap);


        function getMarkers() {
            var bounds = mymap.getBounds();
            console.dir(bounds);
            var ne = bounds._northEast
            console.dir(ne)
            var sw = bounds._southWest
            console.dir(sw)
            // var bbox = "-11.05987446,12.28339928,-101.05987446,62.28339928"
            var bbox = [sw.lng, sw.lat, ne.lng, ne.lat]
            $.getJSON(
                "/mpls-grates/_design/geodd/_geo/geoidx?bbox=" + bbox,
                function (data) {
                    var items = [];
                    $.each(data.rows, function (key, val) {
                        console.dir(val);
                        items.push("<li id='" + key + "'>" + val.id + "</li>");
                        var marker = L.marker([val.geometry.coordinates[1], val.geometry.coordinates[0]]).addTo(
                            mymap).bindPopup(val.id);
                    });
                });
        }

        $(document).ready(function () {
            console.log("ready!");
            getMarkers();
        });

        mymap.on('moveend', getMarkers);
    </script>

</body>

</html>