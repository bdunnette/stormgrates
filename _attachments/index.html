<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #mapid {
            height: 100%;
            width: 100vw;
        }
    </style>
    <title>Minneapolis Storm Grates</title>
</head>

<body>
    <div id="mapid"></div>
    <script>
        var mymap = L.map('mapid').setView([44.9778, -93.2650], 16);

        var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib = 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
        L.tileLayer(
            osmUrl, {
                maxZoom: 18,
                id: 'osm',
                attribution: osmAttrib
            }).addTo(mymap);


        function getMarkers() {
            var bounds = mymap.getBounds();
            var ne = bounds._northEast
            var sw = bounds._southWest
            var bbox = [sw.lng, sw.lat, ne.lng, ne.lat]
            $.getJSON(
                "/mpls-grates/_design/geodd/_geo/geoidx?bbox=" + bbox,
                function (data) {
                    $.each(data.rows, function (key, val) {
                        var marker = L.marker([val.geometry.coordinates[1], val.geometry.coordinates[0]]).addTo(
                            mymap).bindPopup(val.id);
                    });
                });
        }

        $(document).ready(function () {
            mymap.locate({
                setView: true,
                maxZoom: 18
            });
            getMarkers();
        });

        mymap.on('moveend', getMarkers);

        function onLocationFound(e) {
            console.log("location found")
            console.log(e)
        }

        mymap.on('locationfound', onLocationFound);

        function onLocationError(e) {
            console.log("location error")
            console.error(e);
        }

        mymap.on('locationerror', onLocationError);
    </script>

</body>

</html>